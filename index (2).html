<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 智能导演台 - 中文提示词版</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom Scrollbar for nicer look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans selection:bg-indigo-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icons (Inline SVG components to avoid external dependency issues) ---
        const Icons = {
            Camera: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Clapperboard: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20.2 6 3 11l-.9-2.4c-.5-1.1.2-2.3 1.3-2.8l3.2-1.4c1.3-.6 2.8 0 3.3 1l.5 1.3L15 4l3.1 1.4c1.1.5 1.6 1.8 1.1 2.9l-1 2.3Z"/><path d="m4 11 1-2.4"/><path d="m7.3 13.2-1-2.4"/><path d="m10.7 15.4-1-2.4"/><path d="m14 17.6-1-2.4"/><path d="M3 11v9a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-9H3Z"/></svg>,
            Download: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Film: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="3" rx="2" /><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h18"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M17 7.5h4"/><path d="M17 16.5h4"/></svg>,
            User: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Loader2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Sparkles: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
            FileText: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>,
            Copy: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            Check: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="20 6 9 17 4 12"/></svg>,
            Video: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>,
            Wand2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/><path d="M11 3H9"/></svg>,
            Edit3: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Clock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Link: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
            Eye: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            Scissors: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" x2="8.12" y1="4" y2="15.88"/><line x1="14.47" x2="20" y1="14.48" y2="20"/><line x1="8.12" x2="12" y1="8.12" y2="12"/></svg>
        };

        const App = () => {
            const [storyInput, setStoryInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState('');
            const [activeTab, setActiveTab] = useState('script'); // 'script' or 'characters'
            const [copiedId, setCopiedId] = useState(null);

            // Revision State
            const [revising, setRevising] = useState(false);
            const [revisionTarget, setRevisionTarget] = useState(null); 
            const [revisionText, setRevisionText] = useState('');

            const apiKey = ""; // 实际使用时 API KEY 可以在这里，或者通过环境注入

            // Enhanced copy function for broader compatibility
            const handleCopy = (text, id) => {
                if (!text) return;
                
                // Try modern API first
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        setCopiedId(id);
                        setTimeout(() => setCopiedId(null), 2000);
                    }).catch(err => {
                        console.error('Clipboard API failed', err);
                        fallbackCopy(text, id);
                    });
                } else {
                    fallbackCopy(text, id);
                }
            };

            const fallbackCopy = (text, id) => {
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed"; // Avoid scrolling to bottom
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    if (successful) {
                        setCopiedId(id);
                        setTimeout(() => setCopiedId(null), 2000);
                    }
                } catch (err) {
                    console.error('Fallback copy failed', err);
                }
            };

            const handleGenerate = async () => {
                if (!storyInput.trim()) {
                setError('请输入故事内容');
                return;
                }

                setLoading(true);
                setError('');
                setResult(null);

                try {
                const systemPrompt = `
                    你是一位对画面精度和动态连贯性有极高要求的顶级AI视频导演。

                    **你的核心任务：生成可以直接用于 Runyway/Midjourney/可灵/即梦 的精准提示词，杜绝低级逻辑错误。**
                    
                    **【重要】：所有输出必须是中文！所有提示词（Image Prompt 和 Video Prompt）必须完全使用中文输出，严禁出现英文。**

                    **1. 画面提示词 (Image Prompt) - 必须精准且环境饱满：**
                    - **语言**：**纯中文**。
                    - **定格原则**：描述 T=0 秒那一帧的**静止画面**。
                    - **环境至关重要**：绝不能只写“在教室”。必须描述：墙壁的质感（斑驳/洁白）、光线的来源（窗外的夕阳/头顶的冷光）、空气的质感（尘埃飞舞/阴冷潮湿）。
                    - **精准对应**：如果 Shot Type 是“背面中景”，提示词必须包含“背影”，“背面视角”。
                    - **结构**：(镜头角度+景别) + (角色名+视觉标签+具体姿势) + (详细环境描写+道具细节) + (光影氛围+电影质感)。

                    **2. 视频提示词 (Video Prompt) - 必须是动作指令：**
                    - **语言**：**纯中文**。
                    - **动态原则**：描述 T=0 到 T=5 秒的**动作过程**。**拒绝静止形容词！全是动词！**
                    - **严格衔接 (CRITICAL)**：视频的**起始帧**必须完美对应画面的描述。
                        - *错误示例*：画面是背影，视频写“他脸上露出了笑容”（背影看不到脸）。
                        - *正确示例*：画面是背影 -> 视频写“从背影视角开始，他双肩颤抖，随后迈步向前走去，逐渐远离镜头”。
                    - **运镜指令**：必须包含摄像机的运动轨迹（如：镜头向前推进，镜头向右平移，手持跟拍）。
                    - **结构**：[起始状态: 严格复述画面的角度] + [动作: 具体的肢体移动/表情变化] + [运镜: 摄像机怎么动]。

                    **3. 视觉接力机制 (Visual Relay):**
                    - Shot N 的视频结束动作 = Shot N+1 的画面起始状态。
                    - 示例：Shot 1 视频结尾是“他走到了门前停下” -> Shot 2 画面必须是“他站在门前的特写”。

                    **JSON 结构模板：**
                    {
                    "characters": [ { "name": "...", "visual_tag": "...", "personality": "...", "appearance": "...", "motivation": "..." } ],
                    "script": [ 
                        { 
                        "scene_number": 1, 
                        "duration": "5s",
                        "logic_type": "action_relay | scene_change | emotional_insert",
                        "logic_reason": "...",
                        "location": "...", 
                        "time": "...", 
                        "shot_type": "...", 
                        "camera_movement": "...", 
                        "visual_description": "...", 
                        "audio": "...", 
                        "video_prompt": "...", 
                        "image_prompt": "..." 
                        } 
                    ]
                    }
                `;

                // Fixed: Removed incorrect escape characters
                const userPrompt = `请根据以下故事内容生成极具镜头感和逻辑性的脚本。请特别注意：**所有提示词必须是中文**，视频提示词必须体现运动感，且起始状态必须与画面提示词完全一致：\n${storyInput}`;

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: systemPrompt + "\n\n" + userPrompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    }),
                    }
                );

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const data = await response.json();
                const generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (generatedText) {
                    let parsedData;
                    try {
                        parsedData = JSON.parse(generatedText);
                    } catch (e) {
                        const cleanText = generatedText.replace(/```json|```/g, '');
                        parsedData = JSON.parse(cleanText);
                    }
                    setResult(parsedData);
                } else {
                    throw new Error('No content generated');
                }

                } catch (err) {
                setError('生成失败，请重试。错误信息: ' + err.message);
                } finally {
                setLoading(false);
                }
            };

            const handleSmartRevise = async () => {
                if (!revisionText.trim() || !result) return;
                
                setRevising(true);
                
                try {
                    const systemPrompt = `
                        你是一个专业的影视导演 AI。用户正在修改脚本。
                        
                        **修改重点：**
                        1. **环境与动态**：用户可能会要求增加环境细节或让动作更激烈。确保视频提示词始终是**动态的**（使用动词）。
                        2. **首尾衔接**：修改任何一镜，都要检查是否破坏了与下一镜的视觉接力。如果改了，请连同下一镜的开头一起改。
                        3. **语言要求**：修改后的内容必须保持**纯中文**，不要出现英文。
                        
                        **当前 JSON 数据：**
                        ${JSON.stringify(result)}
                        
                        **用户修改指令：**
                        ${revisionText}
                        
                        **输出要求：**
                        纯 JSON 格式。
                    `;

                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: systemPrompt }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        }),
                        }
                    );
                
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                    const data = await response.json();
                    const generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (generatedText) {
                        let parsedData;
                        try {
                            parsedData = JSON.parse(generatedText);
                        } catch (e) {
                            const cleanText = generatedText.replace(/```json|```/g, '');
                            parsedData = JSON.parse(cleanText);
                        }
                        setResult(parsedData);
                        setRevisionTarget(null); 
                        setRevisionText('');
                    }

                } catch (err) {
                    alert('修改失败: ' + err.message);
                } finally {
                    setRevising(false);
                }
            };

            const openRevisionModal = (type, index) => {
                setRevisionTarget({ type, index });
                setRevisionText('');
            };

            const downloadCSV = (type) => {
                if (!result) return;
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
                const processItem = (item) => `"${(item === null || item === undefined ? '' : String(item)).replace(/"/g, '""')}"`;

                if (type === 'characters') {
                csvContent += "角色姓名,视觉一致性标签(Visual Tag),性格特征,外貌特征,核心动机\n";
                result.characters.forEach(char => {
                    const row = [char.name, char.visual_tag || char.appearance, char.personality, char.appearance, char.motivation].map(processItem).join(",");
                    csvContent += row + "\n";
                });
                } else {
                csvContent += "场号,逻辑类型,导演意图,时长,场景/时间,景别/角度,运镜方式,画面描述,第一步：文生图提示词 (Image Prompt),第二步：图生视频提示词 (Video Prompt),台词/音效\n";
                result.script.forEach(shot => {
                    const row = [
                        shot.scene_number,
                        shot.logic_type === 'action_relay' ? '动作接力' : shot.logic_type === 'scene_change' ? '场景切换' : '情绪特写',
                        shot.logic_reason,
                        shot.duration || "5s",
                        `${shot.location || ''} / ${shot.time || ''}`, 
                        shot.shot_type, 
                        shot.camera_movement, 
                        shot.visual_description, 
                        shot.image_prompt, 
                        shot.video_prompt, 
                        shot.audio
                    ].map(processItem).join(",");
                    csvContent += row + "\n";
                });
                }

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `script_export_${type}_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const getLogicBadge = (type) => {
                switch(type) {
                    case 'action_relay': return { icon: <Icons.Link className="w-3 h-3" />, text: "动作接力", color: "bg-blue-100 text-blue-700 border-blue-200" };
                    case 'scene_change': return { icon: <Icons.Clapperboard className="w-3 h-3" />, text: "场景切换", color: "bg-emerald-100 text-emerald-700 border-emerald-200" };
                    case 'emotional_insert': return { icon: <Icons.Eye className="w-3 h-3" />, text: "情绪特写", color: "bg-rose-100 text-rose-700 border-rose-200" };
                    default: return { icon: <Icons.Film className="w-3 h-3" />, text: "常规镜头", color: "bg-slate-100 text-slate-700 border-slate-200" };
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 font-sans selection:bg-indigo-100">
                {/* Header */}
                <header className="bg-white border-b border-slate-200 sticky top-0 z-10 shadow-sm">
                    <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                    <div className="flex items-center gap-2 text-indigo-700">
                        <Icons.Wand2 className="w-6 h-6 text-purple-600" />
                        <div>
                            <h1 className="text-xl font-bold tracking-tight">AI 智能导演台 <span className="text-xs font-normal text-white bg-indigo-600 ml-2 rounded px-1.5 py-0.5">中文版</span></h1>
                        </div>
                    </div>
                    <div className="text-xs text-slate-500 hidden sm:block text-right">
                        <div>环境饱满 | 动态精准</div>
                        <div>纯中文提示词 | 视觉逻辑接力</div>
                    </div>
                    </div>
                </header>

                <main className="max-w-6xl mx-auto px-4 py-8 relative">
                    
                    {/* Input Section */}
                    {!result && (
                    <section className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8 transition-all hover:shadow-md ring-1 ring-slate-100">
                    <label className="block text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                        <Icons.Sparkles className="w-4 h-4 text-amber-500" />
                        输入您的故事（我会精准描述环境光影，并确保视频是真正的“动作”）
                    </label>
                    <textarea
                        className="w-full h-48 p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none resize-none text-slate-700 leading-relaxed placeholder:text-slate-400 bg-slate-50/50"
                        placeholder="例如：
            小李在破旧的教室里焦躁不安，墙皮脱落，光线昏暗。铃声一响，他猛地起身冲出教室，在走廊狂奔，撞到了同学...
            (AI将自动处理：精准的环境描写 + 连贯的动作接力)"
                        value={storyInput}
                        onChange={(e) => setStoryInput(e.target.value)}
                    ></textarea>
                    
                    <div className="mt-4 flex justify-between items-center">
                        <div className="text-xs text-slate-400 flex items-center gap-1">
                            <Icons.Link className="w-3 h-3" />
                            自动处理：环境氛围渲染 + 视频动态指令
                        </div>
                        <div className="flex items-center gap-4">
                            {error && <span className="text-red-500 text-sm">{error}</span>}
                            <button
                            onClick={handleGenerate}
                            disabled={loading || !storyInput.trim()}
                            className={`flex items-center gap-2 px-6 py-2.5 rounded-lg font-bold text-white transition-all transform
                                ${loading || !storyInput.trim() 
                                ? 'bg-slate-300 cursor-not-allowed' 
                                : 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 shadow-lg hover:shadow-indigo-200 active:scale-95'}`}
                            >
                            {loading ? (
                                <>
                                <Icons.Loader2 className="w-5 h-5 animate-spin" />
                                <span>导演正在构思运镜...</span>
                                </>
                            ) : (
                                <>
                                <Icons.Clapperboard className="w-5 h-5" />
                                <span>生成逻辑分镜脚本</span>
                                </>
                            )}
                            </button>
                        </div>
                    </div>
                    </section>
                    )}

                    {/* Results Section */}
                    {result && (
                    <section className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                        {/* Action Bar */}
                        <div className="flex justify-between items-end mb-6">
                            <div className="flex items-center gap-1 border-b border-slate-200">
                                <button
                                    onClick={() => setActiveTab('script')}
                                    className={`px-4 py-3 text-sm font-bold rounded-t-lg border-b-2 transition-colors flex items-center gap-2
                                    ${activeTab === 'script' 
                                        ? 'border-indigo-600 text-indigo-700 bg-white' 
                                        : 'border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-50'}`}
                                >
                                    <Icons.Camera className="w-4 h-4" />
                                    逻辑分镜表
                                </button>
                                <button
                                    onClick={() => setActiveTab('characters')}
                                    className={`px-4 py-3 text-sm font-bold rounded-t-lg border-b-2 transition-colors flex items-center gap-2
                                    ${activeTab === 'characters' 
                                        ? 'border-indigo-600 text-indigo-700 bg-white' 
                                        : 'border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-50'}`}
                                >
                                    <Icons.User className="w-4 h-4" />
                                    人物档案
                                </button>
                            </div>
                            <button 
                                onClick={() => setResult(null)} 
                                className="text-xs text-slate-400 hover:text-slate-600 underline pb-3"
                            >
                                返回重写故事
                            </button>
                        </div>

                        {/* Script Table */}
                        {activeTab === 'script' && (
                        <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                            <div className="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                            <div>
                                <h3 className="font-bold text-slate-800 flex items-center gap-2 text-lg">
                                    <Icons.FileText className="w-5 h-5 text-indigo-600" /> 拍摄脚本表
                                </h3>
                                <p className="text-xs text-slate-500 mt-1">
                                    观察 <span className="font-bold text-blue-600">动作接力</span> 标签：这代表画面与上一镜视频无缝衔接。
                                </p>
                            </div>
                            <button 
                                onClick={() => downloadCSV('script')}
                                className="text-sm flex items-center gap-1 text-white bg-emerald-600 hover:bg-emerald-700 font-medium px-4 py-2 rounded-lg shadow-sm transition-colors"
                            >
                                <Icons.Download className="w-4 h-4" /> 导出 CSV
                            </button>
                            </div>
                            
                            <div className="divide-y divide-slate-100">
                                {result.script.map((shot, idx) => {
                                    const badge = getLogicBadge(shot.logic_type);
                                    return (
                                    <div key={idx} className="p-6 hover:bg-slate-50 transition-colors group relative">
                                        {/* Edit Button */}
                                        <button 
                                            onClick={() => openRevisionModal('script', idx)}
                                            className="absolute top-4 right-4 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 p-2 rounded-full transition-all flex items-center gap-1 text-xs border border-transparent hover:border-indigo-100"
                                            title="AI 智能修改"
                                        >
                                            <Icons.Sparkles className="w-4 h-4" /> 
                                            <span className="hidden sm:inline">修改此镜</span>
                                        </button>

                                        {/* Scene Header */}
                                        <div className="flex flex-col md:flex-row md:items-start gap-4 mb-4 pr-16">
                                            <div className="flex-shrink-0 w-24 text-center">
                                                <span className="block text-2xl font-black text-slate-200">#{shot.scene_number}</span>
                                                <span className="inline-block bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded-full mt-1 font-mono">
                                                    {shot.duration || "5s"}
                                                </span>
                                            </div>
                                            
                                            <div className="flex-grow">
                                                {/* Logic Badge & Reason */}
                                                <div className="flex items-center gap-2 mb-2">
                                                    <div className={`flex items-center gap-1 px-2 py-1 rounded text-[10px] font-bold border ${badge.color}`}>
                                                        {badge.icon}
                                                        {badge.text}
                                                    </div>
                                                    {shot.logic_reason && (
                                                        <span className="text-[10px] text-slate-400 italic">
                                                            — 导演意图: {shot.logic_reason}
                                                        </span>
                                                    )}
                                                </div>

                                                {/* Shot Details */}
                                                <div className="flex flex-wrap items-center gap-2 mb-2">
                                                    <span className="font-bold text-slate-800">{shot.location}</span>
                                                    <span className="text-xs text-slate-400">|</span>
                                                    <span className="text-sm text-slate-600">{shot.time}</span>
                                                    <span className="ml-auto flex gap-2">
                                                        <span className="bg-slate-100 text-slate-700 px-2 py-0.5 rounded text-xs font-bold border border-slate-200">
                                                            {shot.shot_type}
                                                        </span>
                                                        <span className="bg-purple-100 text-purple-700 px-2 py-0.5 rounded text-xs font-bold border border-purple-200">
                                                            {shot.camera_movement}
                                                        </span>
                                                    </span>
                                                </div>
                                                <p className="text-slate-700 leading-relaxed mb-2 font-medium">
                                                    {shot.visual_description}
                                                </p>
                                                <div className="text-sm text-slate-500 italic bg-slate-50/50 p-2 rounded border-l-2 border-slate-300">
                                                    音效/台词: {shot.audio}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Prompt Timeline */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 ml-0 md:ml-24 relative">
                                            {/* Connector Line (Visual Guide for Continuity) */}
                                            {idx < result.script.length - 1 && shot.logic_type !== 'emotional_insert' && (
                                                <div className={`absolute left-1/2 bottom-[-40px] w-0.5 h-10 hidden md:block z-0 opacity-50 border-l border-dashed 
                                                    ${result.script[idx+1]?.logic_type === 'scene_change' ? 'border-transparent' : 'border-indigo-400'}`}>
                                                </div>
                                            )}
                                            {idx < result.script.length - 1 && result.script[idx+1]?.logic_type === 'scene_change' && (
                                                <div className="absolute left-1/2 bottom-[-25px] transform -translate-x-1/2 hidden md:flex items-center gap-1 bg-white px-2 py-1 border border-slate-200 rounded-full text-[10px] text-slate-400 z-10">
                                                    <Icons.Scissors className="w-3 h-3" /> 场景切断
                                                </div>
                                            )}


                                            {/* Image Prompt (Start State) */}
                                            <div className="bg-amber-50/50 rounded-lg border border-amber-100 p-3 relative hover:border-amber-300 transition-colors z-10">
                                                <div className="flex justify-between items-center mb-2 border-b border-amber-100 pb-2">
                                                    <div className="flex items-center gap-2 text-amber-700 font-bold text-xs uppercase tracking-wider">
                                                        <div className="bg-amber-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] shadow-sm">Img</div>
                                                        画面 (T=0s 静态·环境饱满)
                                                    </div>
                                                    <button 
                                                        onClick={() => handleCopy(shot.image_prompt, `img-${idx}`)}
                                                        className="text-amber-600 hover:bg-amber-100 p-1.5 rounded transition-colors"
                                                    >
                                                        {copiedId === `img-${idx}` ? <Icons.Check className="w-4 h-4" /> : <div className="flex items-center gap-1 text-xs"><Icons.Copy className="w-3 h-3" /> 复制</div>}
                                                    </button>
                                                </div>
                                                <p className="text-xs text-slate-700 leading-relaxed font-mono break-words">{shot.image_prompt}</p>
                                            </div>

                                            {/* Video Prompt (Action -> End State) */}
                                            <div className="bg-indigo-50/50 rounded-lg border border-indigo-100 p-3 relative hover:border-indigo-300 transition-colors z-10">
                                                <div className="flex justify-between items-center mb-2 border-b border-indigo-100 pb-2">
                                                    <div className="flex items-center gap-2 text-indigo-700 font-bold text-xs uppercase tracking-wider">
                                                        <div className="bg-indigo-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] shadow-sm">Vid</div>
                                                        视频 (T=0s → T=5s 动态·严密衔接)
                                                    </div>
                                                    <button 
                                                        onClick={() => handleCopy(shot.video_prompt, `vid-${idx}`)}
                                                        className="text-indigo-600 hover:bg-indigo-100 p-1.5 rounded transition-colors"
                                                    >
                                                        {copiedId === `vid-${idx}` ? <Icons.Check className="w-4 h-4" /> : <div className="flex items-center gap-1 text-xs"><Icons.Copy className="w-3 h-3" /> 复制</div>}
                                                    </button>
                                                </div>
                                                <p className="text-xs text-slate-700 leading-relaxed font-mono break-words">{shot.video_prompt}</p>
                                            </div>
                                        </div>
                                    </div>
                                );})}
                            </div>
                        </div>
                        )}

                        {/* Characters Tab (Same as before) */}
                        {activeTab === 'characters' && (
                        <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                            <div className="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                            <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                <Icons.User className="w-5 h-5 text-indigo-600" /> 人物一致性档案
                            </h3>
                            <button 
                                onClick={() => downloadCSV('characters')}
                                className="text-sm flex items-center gap-1 text-white bg-emerald-600 hover:bg-emerald-700 font-medium px-4 py-2 rounded-lg shadow-sm transition-colors"
                            >
                                <Icons.Download className="w-4 h-4" /> 导出 CSV
                            </button>
                            </div>
                            <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm">
                                <thead>
                                <tr className="bg-slate-100 text-slate-600 uppercase tracking-wider">
                                    <th className="px-6 py-4 font-bold w-32">角色姓名</th>
                                    <th className="px-6 py-4 font-bold w-1/3 text-indigo-700">视觉一致性标签</th>
                                    <th className="px-6 py-4 font-bold">外貌特征</th>
                                    <th className="px-6 py-4 font-bold">性格特征</th>
                                    <th className="px-6 py-4 font-bold w-16">操作</th>
                                </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                {result.characters.map((char, idx) => (
                                    <tr key={idx} className="hover:bg-slate-50 transition-colors">
                                    <td className="px-6 py-4 font-bold text-slate-800 text-lg">{char.name}</td>
                                    <td className="px-6 py-4">
                                        <div className="bg-indigo-50 border border-indigo-200 text-indigo-900 p-3 rounded-md text-xs font-mono font-medium shadow-sm">
                                            {char.visual_tag || "自动生成中..."}
                                        </div>
                                    </td>
                                    <td className="px-6 py-4 text-slate-700 leading-relaxed">{char.appearance}</td>
                                    <td className="px-6 py-4 text-slate-700">
                                        <span className="bg-slate-100 text-slate-600 px-2 py-1 rounded-md text-xs font-bold">{char.personality}</span>
                                    </td>
                                    <td className="px-6 py-4">
                                        <button 
                                            onClick={() => openRevisionModal('character', idx)}
                                            className="text-slate-400 hover:text-indigo-600 p-2 rounded-full hover:bg-indigo-50 transition-colors"
                                        >
                                            <Icons.Edit3 className="w-4 h-4" />
                                        </button>
                                    </td>
                                    </tr>
                                ))}
                                </tbody>
                            </table>
                            </div>
                        </div>
                        )}
                        
                        {/* Revision Modal (Same as before) */}
                        {revisionTarget && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg border border-slate-200 animate-in fade-in zoom-in-95 duration-200">
                                <div className="p-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                            <Icons.Sparkles className="w-5 h-5 text-indigo-600" />
                                            AI 智能修改
                                        </h3>
                                        <button onClick={() => setRevisionTarget(null)} className="text-slate-400 hover:text-slate-600">
                                            <Icons.X className="w-5 h-5" />
                                        </button>
                                    </div>
                                    
                                    <div className="mb-4">
                                        <p className="text-sm text-slate-600 mb-2">
                                            输入您的修改意见：
                                        </p>
                                        <textarea 
                                            className="w-full h-32 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none resize-none text-slate-700"
                                            placeholder="例如：把这个动作改得更激烈一点，或者把背景改成下雨天..."
                                            value={revisionText}
                                            onChange={(e) => setRevisionText(e.target.value)}
                                        />
                                    </div>
                                    
                                    <div className="flex justify-end gap-3">
                                        <button 
                                            onClick={() => setRevisionTarget(null)}
                                            className="px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg"
                                        >
                                            取消
                                        </button>
                                        <button 
                                            onClick={handleSmartRevise}
                                            disabled={revising || !revisionText.trim()}
                                            className="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 disabled:opacity-50 flex items-center gap-2"
                                        >
                                            {revising ? <Icons.Loader2 className="w-4 h-4 animate-spin" /> : <Icons.Wand2 className="w-4 h-4" />}
                                            {revising ? "AI 正在同步修改..." : "确认并同步"}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        )}

                    </section>
                    )}
                </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>